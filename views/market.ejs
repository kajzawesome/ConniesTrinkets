<%- include('partials/header', { title: "Market | Connieâ€™s Trinkets", loggedIn: loggedIn }) %>

<section class="market">
  <h1>Items</h1>
  <p>Choose an item to claim or view details.</p>

  <form class="market-filters" method="GET" action="/market">
    <div class="search-box">
      <label for="q">Search:</label>
      <input
        type="text"
        id="q"
        name="q"
        placeholder="Search name or description"
        value="<%= q || '' %>"
      />
      <button type="submit" class="btn">Search</button>
      <a href="/market" class="btn btn-secondary">Clear</a>
    </div>

    <fieldset class="category-filters">
      <legend>Categories</legend>
      <% if (categories && categories.length > 0) { %>
        <% categories.forEach(cat => { %>
          <label class="checkbox-inline">
            <input
              type="checkbox"
              name="categories"
              value="<%= cat %>"
              <%= (selectedCategories || []).includes(cat) ? 'checked' : '' %>
            />
            <%= cat %>
          </label>
        <% }) %>
      <% } %>
    </fieldset>

    <label class="checkbox-inline">
      <input
        type="checkbox"
        name="showUnclaimed"
        value="1"
        <%= showUnclaimed ? 'checked' : '' %>
      />
      Show only unclaimed items
    </label>
  </form>

  <div class="item-grid">
    <% if (items && items.length > 0) { %>
      <% items.forEach(item => { %>
        <div class="item-card <%= item.userID ? 'is-claimed' : '' %>" data-item-id="<%= item.itemID %>">
          <img
            src="<%= item.itemImagePath || '/images/default.jpg' %>"
            alt="<%= item.itemName %>"
          />

          <h3><%= item.itemName %></h3>
          <p><%= item.itemDesc %></p>

          <em><span class="claim-text">
            <% if (item.userID) { %>
              Claimed by <%= (item.userID === user.userID) ? 'you' : 'someone' %>
            <% } %>
          </span></em>

          <div class="claimed-status">
            <% if (!item.userID) { %>
              <form action="/claim/<%= item.itemID %>" method="POST" class="claim-form">
                <button type="submit" class="btn small">Claim Item</button>
              </form>
            <% } else if (item.userID === user.userID) { %>
              <form action="/unclaim/<%= item.itemID %>" method="POST" class="unclaim-form">
                <button type="submit" class="btn btn-danger">Unclaim</button>
              </form>
            <% } %>

            <% if (user.role === 'M') { %>
              <form class="edit-form" action="/item/<%= item.itemID %>/edit" method="GET">
                <button class="btn small btn-danger">Edit</button>
              </form>
              <form class="delete-form" action="/item/<%= item.itemID %>/delete" method="POST">
                <button class="btn small btn-danger">Delete</button>
              </form>
            <% } %>
          </div>

        </div>
      <% }) %>
    <% } else { %>
      <p class="no-items">No items found.</p>
    <% } %>
  </div>
  <form action="/item/add" method="GET">
    <button type="submit" class="btn btn-danger small">Add Item</button>
  </form>
</section>

<%- include('partials/footer') %>